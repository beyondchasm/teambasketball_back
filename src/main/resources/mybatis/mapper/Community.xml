<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper
  namespace="site.beyondchasm.teambasketball.community.mapper.CommunityMapper">

  <!-- 채널 결과 매핑 -->
  <resultMap id="ChannelResultMap"
    type="site.beyondchasm.teambasketball.community.model.ChannelDto">
    <id property="channelId" column="channel_id"/>
    <result property="channelName" column="channel_name"/>
    <result property="channelType" column="channel_type"/>
    <result property="feedCnt" column="feed_cnt"/>
  </resultMap>

  <!-- 피드 결과 매핑 -->
  <resultMap id="FeedResultMap" type="site.beyondchasm.teambasketball.community.model.FeedDto">
    <id property="feedId" column="feed_id"/>
    <result property="isTeam" column="is_team"/>
    <result property="teamId" column="team_id"/>
    <result property="channelId" column="channel_id"/>
    <result property="title" column="title"/>
    <result property="contentType" column="content_type"/>
    <result property="content" column="content"/>
    <result property="userId" column="user_id"/>
    <result property="createdAt" column="created_at"/>
    <result property="updatedAt" column="updated_at"/>
    <result property="viewCnt" column="view_cnt"/>
    <result property="isReaction" column="is_reaction"/>
    <result property="likeCnt" column="like_cnt"/>
    <result property="dislikeCnt" column="dislike_cnt"/>
    <result property="commentCnt" column="comment_cnt"/>
  </resultMap>

  <!-- 피드 이미지 결과 매핑 -->
  <resultMap id="FeedImageResultMap"
    type="site.beyondchasm.teambasketball.community.model.FeedImageDto">
    <id property="feedId" column="feed_id"/>
    <result property="seq" column="seq"/>
    <result property="imagePath" column="image_path"/>
    <result property="isMain" column="is_main"/>
  </resultMap>

  <!-- 댓글 결과 매핑 -->
  <resultMap id="CommentResultMap"
    type="site.beyondchasm.teambasketball.community.model.CommentDto">
    <id property="commentId" column="comment_id"/>
    <result property="feedId" column="feed_id"/>
    <result property="content" column="content"/>
    <result property="userId" column="user_id"/>
    <result property="createdAt" column="created_at"/>
    <result property="updatedAt" column="updated_at"/>
  </resultMap>

  <!-- 쿼리문 예시 -->
  <select id="getChannels" resultMap="ChannelResultMap">
    SELECT *
    FROM
      tbl_channel_bais
    WHERE use_yn = 'Y'
    ORDER BY sort ASC
  </select>

  <select id="getFeedListCount"
    parameterType="site.beyondchasm.teambasketball.community.command.FeedFilterCommand"
    resultType="long">
    SELECT count(*)
    FROM
      tbl_feed_bais
    WHERE is_team = false
      and channel_id = #{filter.channelId}
  </select>

  <select id="getFeedsByChannel"
    parameterType="site.beyondchasm.teambasketball.community.command.FeedFilterCommand"
    resultMap="FeedResultMap">
    SELECT a.feed_id,
           a.is_team,
           a.channel_id,
           a.team_id,
           a.title,
           a.content_type,
           a.content,
           a.user_id,
           a.created_at,
           a.updated_at,
           (SELECT count(*) FROM tbl_feed_view x WHERE x.feed_id = a.feed_id)    AS view_cnt,
           (SELECT count(*) FROM tbl_comment_bais x WHERE x.feed_id = a.feed_id) AS comment_cnt,
           (SELECT count(*)
            FROM
              tbl_feed_reaction x
            WHERE x.feed_id = a.feed_id
              AND x.type = 'like')                                               AS like_cnt,
           (SELECT count(*)
            FROM
              tbl_feed_reaction x
            WHERE x.feed_id = a.feed_id
              AND x.type = 'dislike')                                            AS dislike_cnt,
           (SELECT nullif(x.type, 'N')
            FROM
              tbl_feed_reaction x
            WHERE x.feed_id = a.feed_id
              AND user_id = #{filter.loginedUserId})                             AS is_reaction
    FROM
      tbl_feed_bais a
    WHERE a.is_team = false
      AND a.channel_id = #{filter.channelId}
    ORDER BY a.created_at DESC
      LIMIT #{limit}
    OFFSET #{offset}
  </select>

  <!-- 쿼리문 나머지들도 동일한 방식으로 변경 가능 -->
  <!-- 피드 업데이트 -->
  <update id="updateFeed" parameterType="site.beyondchasm.teambasketball.community.model.FeedDto">
    UPDATE tbl_feed_bais
    SET title        = #{title},
        content_type = #{contentType},
        content      = #{content},
        user_id      = #{userId},
        updated_at   = #{updatedAt},
        view_cnt     = #{viewCnt}
    WHERE feed_id = #{feedId}
  </update>

  <!-- 댓글 업데이트 -->
  <update id="updateComment"
    parameterType="site.beyondchasm.teambasketball.community.model.CommentDto">
    UPDATE tbl_comment_bais
    SET content    = #{content},
        updated_at = #{updatedAt}
    WHERE comment_id = #{commentId}
  </update>

</mapper>
