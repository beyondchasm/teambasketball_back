<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper
  namespace="site.beyondchasm.teambasketball.match.mapper.MatchMapper">

  <!-- 매치 정보를 가져오는 resultMap -->
  <resultMap id="matchResultDto"
    type="site.beyondchasm.teambasketball.match.model.MatchDto">
    <id property="match_id" column="match_id"/>
    <result property="match_type" column="match_type"/>
    <result property="match_detail_type" column="match_detail_type"/>
    <result property="region_code" column="region_code"/>
    <result property="match_date" column="match_date"/>
    <result property="start_time" column="start_time"/>
    <result property="end_time" column="end_time"/>
    <result property="join_fee" column="join_fee"/>
    <result property="description" column="description"/>
    <result property="status" column="status"/>
    <result property="max_member_count" column="max_member_count"/>
    <result property="host_user_id" column="host_user_id"/>
    <result property="created_at" column="created_at"/>
    <result property="updated_at" column="updated_at"/>
    <!-- 코트 정보 참조 -->
    <collection property="court" javaType="site.beyondchasm.teambasketball.court.model.CourtDto"
      column="court_id"
      select="site.beyondchasm.teambasketball.court.mapper.CourtMapper.getCourtDetail"/>
    <!-- 매치 멤버 정보 참조 -->
    <collection property="members"
      ofType="site.beyondchasm.teambasketball.match.model.MatchMemberDto"
      column="match_id"
      select="site.beyondchasm.teambasketball.match.mapper.MatchMapper.getMatchMembers"/>
  </resultMap>

  <!-- 매치 멤버 정보를 가져오는 resultMap -->
  <resultMap id="matchMemberResultDto"
    type="site.beyondchasm.teambasketball.match.model.MatchMemberDto">
    <id property="match_id" column="match_id"/>
    <result property="status" column="status"/>
    <result property="joined_at" column="joined_at"/>
    <!-- 플레이어 정보 참조 -->
    <collection property="player" javaType="site.beyondchasm.teambasketball.player.model.PlayerDto"
      column="user_id"
      select="site.beyondchasm.teambasketball.player.mapper.PlayerMapper.getPlayerDetail"/>
  </resultMap>

  <!-- 매치 리스트의 개수 가져오기 -->
  <select id="getMatchListCount" resultType="long"
    parameterType="site.beyondchasm.teambasketball.match.command.MatchFilterCommand">
    SELECT COUNT(*) FROM tbl_match_bais a
    <where>
      <if test="filter.match_type != null and !filter.match_type.isEmpty()">
        AND a.match_type IN
        <foreach item="item" collection="filter.match_type" open="(" separator="," close=")">
          #{item}
        </foreach>
      </if>
      <if test="filter.region_code != null and !filter.region_code.isEmpty()">
        AND a.region_code = #{filter.region_code}
      </if>
      AND a.match_date = #{filter.select_date}
    </where>
  </select>

  <!-- 매치 리스트 가져오기 -->
  <select id="getMatchList" resultMap="matchResultDto"
    parameterType="site.beyondchasm.teambasketball.match.command.MatchFilterCommand">
    SELECT a.match_id,
    a.match_type,
    a.match_detail_type,
    a.court_id,
    a.region_code,
    a.match_date,
    a.start_time,
    a.end_time,
    a.join_fee,
    a.description,
    a.status,
    a.max_member_count,
    a.host_user_id,
    a.created_at,
    a.updated_at
    FROM tbl_match_bais a
    <where>
      <if test="filter.match_type != null and !filter.match_type.isEmpty()">
        AND a.match_type IN
        <foreach item="item" collection="filter.match_type" open="(" separator="," close=")">
          #{item}
        </foreach>
      </if>
      <if test="filter.region_code != null and !filter.region_code.isEmpty()">
        AND a.region_code = #{filter.region_code}
      </if>
      AND a.match_date = #{filter.select_date}
    </where>
    ORDER BY a.match_id ASC
  </select>

  <!-- 매치 상세 정보 가져오기 -->
  <select id="getMatchDetail" parameterType="java.lang.Long"
    resultMap="matchResultDto">
    SELECT
      a.match_id,
      a.match_type,
      a.match_detail_type,
      a.court_id,
      a.region_code,
      a.match_date,
      a.start_time,
      a.end_time,
      a.join_fee,
      a.description,
      a.status,
      a.max_member_count,
      a.host_user_id,
      a.created_at,
      a.updated_at
    FROM
      tbl_match_bais a
    WHERE a.match_id = #{match_id}
  </select>

  <!-- 사용자가 참여한 매치 정보 가져오기 -->
  <select id="getMyMatchDetail" parameterType="java.lang.Long"
    resultMap="matchResultDto">
    SELECT
      a.match_id,
      a.match_type,
      a.match_detail_type
    FROM
      tbl_match_bais                a
        INNER JOIN tbl_match_member b
                   ON a.match_id = b.match_id
    WHERE b.user_id = #{user_id}
  </select>

  <!-- 매치에 참여한 멤버 목록 가져오기 -->
  <select id="getMatchMembers" resultMap="matchMemberResultDto">
    SELECT
      a.match_id,
      a.user_id,
      a.status,
      a.joined_at
    FROM
      tbl_match_member a
    WHERE a.match_id = #{match_id}
  </select>

  <!-- 매치 생성 -->
  <insert id="createMatch"
    parameterType="site.beyondchasm.teambasketball.match.command.MatchCreateCommand"
    useGeneratedKeys="true" keyProperty="match_id">
    INSERT
    INTO tbl_match_bais
    (
      match_type, match_detail_type, court_id, region_code, match_date, start_time, end_time,
      join_fee, description,
      max_member_count
        host_user_id,
      status, created_at, updated_at
    )
    VALUES (
             #{match_type}, #{match_detail_type}, #{court_id}, #{region_code}, #{match_date},
             #{start_time},
             #{end_time}, #{join_fee}, #{description}, #{max_member_count}, #{host_user_id},
             #{status}, NOW(), NOW()
           )
  </insert>

  <!-- 매치 수정 -->
  <update id="editMatch"
    parameterType="site.beyondchasm.teambasketball.match.command.MatchUpdateCommand">
    UPDATE tbl_match_bais
    <set>
      <if test="match_type != null">match_type = #{match_type},</if>
      <if test="match_detail_type != null">match_detail_type = #{match_detail_type},</if>
      <if test="court_id != null">court_id = #{court_id},</if>
      <if test="region_code != null">region_code = #{region_code},</if>
      <if test="match_date != null">match_date = #{match_date},</if>
      <if test="start_time != null">start_time = #{start_time},</if>
      <if test="end_time != null">end_time = #{end_time},</if>
      <if test="join_fee != null">join_fee = #{join_fee},</if>
      <if test="description != null">description = #{description},</if>
      <if test="status != null">status = #{status},</if>
      updated_at = NOW()
    </set>
    WHERE match_id = #{match_id}
  </update>

  <!-- 매치 멤버 추가 -->
  <insert id="addMatchMember"
    parameterType="site.beyondchasm.teambasketball.match.model.MatchMemberDto">
    INSERT
    INTO tbl_match_member
    (
      match_id, user_id, status, joined_at
    )
    VALUES (
             #{match_id}, #{user_id}, #{status}, NOW()
           )
  </insert>

  <!-- 매치 멤버 삭제 -->
  <delete id="removeMatchMember"
    parameterType="site.beyondchasm.teambasketball.match.model.MatchMemberDto">
    DELETE
    FROM
      tbl_match_member
    WHERE match_id = #{match_id}
      AND user_id = #{user_id}
  </delete>

  <!-- 매치 멤버 상태 변경 -->
  <update id="updateMatchMemberStatus"
    parameterType="site.beyondchasm.teambasketball.match.model.MatchMemberDto">
    UPDATE tbl_match_member
    SET status = #{status}
    WHERE match_id = #{match_id}
      AND user_id = #{user_id}
  </update>

</mapper>
